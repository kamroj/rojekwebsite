---
import PageHeaderSsg from '../PageHeaderSsg.astro';
import BreadcrumbsSsg from '../BreadcrumbsSsg.astro';

import maxWidthStyles from '../../../ui/MaxWidthContainer.module.css';
import homeHeaderStyles from '../../../../views/HomeView.module.css';
import styles from '../../../../views/AboutUsView.module.css';
import { IoMdArrowDropright } from 'react-icons/io';
import { FiPhone, FiMail } from 'react-icons/fi';

import { loadTranslationJson } from '../../../../lib/i18n/resources.js';
import { t as tt } from '../../../../lib/i18n/t.js';
import { getSectionPath } from '../../../../lib/i18n/routing.js';
import { fetchAboutPageData } from '../../../../lib/sanity/aboutPage.js';
import { getSanityImageProps } from '../../../../lib/sanity/sanityImageProps.js';

const { lang = 'pl' } = Astro.props;

const tr = await loadTranslationJson(lang);
const t = (key, def = '') => tt(tr, key, def);

const breadcrumbs = [
  { label: t('breadcrumbs.home', 'Home'), to: getSectionPath(lang, 'home') },
  { label: t('breadcrumbs.about', 'About') },
];

let aboutData = null;
try {
  aboutData = await fetchAboutPageData({ lang });
} catch (e) {
  console.warn('[sanity][about] fetch failed', e);
}

const headerImage = aboutData?.headerImage || null;
const headerImageSrc = headerImage?.asset?.url || '/images/company/company-top.jpg';

const whyUsDescription = aboutData?.whyUsDescription || '';
const whyUsVideoUrl = aboutData?.whyUsVideoUrl || '';
const whyUsPoints = Array.isArray(aboutData?.whyUsPoints) ? aboutData.whyUsPoints : [];

const historyDescription = aboutData?.historyDescription || '';
const historyDescriptionParagraphs = historyDescription
  .split(/\r?\n+/)
  .map((paragraph) => paragraph.trim())
  .filter(Boolean);
const historyItems = Array.isArray(aboutData?.historyItems) ? aboutData.historyItems : [];

const management = Array.isArray(aboutData?.management) ? aboutData.management : [];
---

<div>
  <PageHeaderSsg
    imageSrc={headerImageSrc}
    title={t('pageTitle.about', 'O Firmie')}
    height={500}
  />

  <div class={maxWidthStyles.root} data-max-width-container="true">
    <BreadcrumbsSsg items={breadcrumbs} />

    <section>
      <div class={`${homeHeaderStyles.headerWrap} full-width`}>
        <div class={homeHeaderStyles.productHeader}>{t('sections.whyUs', 'DLACZEGO MY?')}</div>
        <div class={homeHeaderStyles.productHeaderSubtitle}>
          {t('aboutPage.headers.whyUsSubtitle', 'Co odróżnia nas od innych')}
        </div>
      </div>

      <div class={styles.whyUsContainer}>
        <div class={styles.whyUsContentContainer}>
          {whyUsDescription && <p>{whyUsDescription}</p>}

          {whyUsPoints.length > 0 && (
            <ul class={styles.valueList}>
              {whyUsPoints.map((point) => (
                <li class={styles.valueItem} data-reveal>
                  {point.title && <h3>{point.title}</h3>}
                  {point.description && <p>{point.description}</p>}
                </li>
              ))}
            </ul>
          )}
        </div>

        {whyUsVideoUrl && (
          <div class={styles.headquartersImage} data-reveal>
            <div class={styles.mediaSpinnerHost} data-media-spinner>
              <div class={styles.mediaSpinnerOverlay} aria-hidden="true">
                <span class={styles.mediaSpinnerRing}></span>
              </div>
              <video
                src={whyUsVideoUrl}
                autoplay
                muted
                loop
                playsinline
                preload="metadata"
                aria-label={t('headquarters.imageAlt', 'Siedziba firmy ROJEK')}
              ></video>
            </div>
          </div>
        )}
      </div>
    </section>

    <section class={styles.historySection}>
      <div class={`${homeHeaderStyles.headerWrap} full-width`}>
        <div class={homeHeaderStyles.productHeader}>{t('history.title', 'Nasza Historia')}</div>
        <div class={homeHeaderStyles.productHeaderSubtitle}>
          {t('aboutPage.headers.historySubtitle', 'Jak zmienialiśmy się przez lata')}
        </div>
      </div>

      {historyDescriptionParagraphs.length > 0 && (
        <div class={styles.introText}>
          {historyDescriptionParagraphs.map((paragraph) => (
            <p>{paragraph}</p>
          ))}
        </div>
      )}

      {historyItems.length > 0 && (
        <>
          <div class={styles.historyTabs} role="tablist" aria-label={t('aboutPage.historyTabsAria', 'Lata rozwoju firmy')}>
            {historyItems.map((item, idx) => (
              <>
                <button
                  type="button"
                  class={styles.historyTab}
                  id={`history-tab-${idx}`}
                  role="tab"
                  aria-selected={idx === 0 ? 'true' : 'false'}
                  aria-controls={`history-panel-${idx}`}
                  tabindex={idx === 0 ? '0' : '-1'}
                  data-history-tab
                >
                  {item.year}
                </button>
                {idx < historyItems.length - 1 && (
                  <IoMdArrowDropright className={styles.historyTabSeparator} aria-hidden="true" />
                )}
              </>
            ))}
          </div>

          <div class={styles.historyPanels}>
            {historyItems.map((item, idx) => {
              const imageProps = getSanityImageProps(item.image, {
                widths: [420, 640, 960],
                sizes: '(max-width: 768px) 100vw, 40vw',
                loading: 'lazy',
                altFallback: item.imageAlt || t('aboutPage.historyImageAlt', 'Zdjęcie ilustrujące etap rozwoju firmy'),
              });

              const itemDescriptionParagraphs = (item.description || '')
                .split(/\r?\n+/)
                .map((paragraph) => paragraph.trim())
                .filter(Boolean);

              return (
                <article
                  class={`${styles.historyPanel} ${idx === 0 ? styles.historyPanelActive : ''}`.trim()}
                  id={`history-panel-${idx}`}
                  role="tabpanel"
                  aria-labelledby={`history-tab-${idx}`}
                  data-active={idx === 0 ? 'true' : 'false'}
                  data-history-panel
                  data-reveal
                >
                  <div class={styles.historyPanelContent}>
                    <h3 class={styles.historyPanelMeta}>{item.year}{item.title ? ` — ${item.title}` : ''}</h3>
                    {itemDescriptionParagraphs.map((paragraph) => (
                      <p>{paragraph}</p>
                    ))}
                  </div>

                  {imageProps && (
                    <div class={styles.historyPanelImage}>
                      <div class={styles.mediaSpinnerHost} data-media-spinner>
                        <div class={styles.mediaSpinnerOverlay} aria-hidden="true">
                          <span class={styles.mediaSpinnerRing}></span>
                        </div>
                        <img
                          src={imageProps.src}
                          srcset={imageProps.srcset}
                          sizes={imageProps.sizes}
                          width={imageProps.width}
                          height={imageProps.height}
                          alt={item.imageAlt || imageProps.alt}
                          loading={imageProps.loading}
                          decoding={imageProps.decoding}
                          fetchpriority={imageProps.fetchpriority}
                        />
                      </div>
                    </div>
                  )}
                </article>
              );
            })}
          </div>
        </>
      )}
    </section>

    <section class={styles.managementSection}>
      <div class={`${homeHeaderStyles.headerWrap} full-width`}>
        <div class={homeHeaderStyles.productHeader}>{t('management.title', 'Management')}</div>
        <div class={homeHeaderStyles.productHeaderSubtitle}>
          {t('management.subtitle', 'Poznaj osoby odpowiedzialne za rozwój firmy')}
        </div>
      </div>

      <div class={styles.managementGrid} style="display: grid;">
        {management.map((m) => {
          const photoProps = getSanityImageProps(m.photo, {
            widths: [320, 480, 640],
            sizes: '(max-width: 768px) 100vw, 25vw',
            loading: 'lazy',
            altFallback: m.photoAlt || m.name,
          });

          return (
            <article class={styles.managerCard}>
              {photoProps && (
                <div class={styles.managerImageWrapper}>
                  <div class={styles.mediaSpinnerHost} data-media-spinner>
                    <div class={styles.mediaSpinnerOverlay} aria-hidden="true">
                      <span class={styles.mediaSpinnerRing}></span>
                    </div>
                    <img
                      class={styles.managerPhoto}
                      src={photoProps.src}
                      srcset={photoProps.srcset}
                      sizes={photoProps.sizes}
                      width={photoProps.width}
                      height={photoProps.height}
                      alt={m.photoAlt || photoProps.alt}
                      loading={photoProps.loading}
                      decoding={photoProps.decoding}
                      fetchpriority={photoProps.fetchpriority}
                    />
                  </div>
                </div>
              )}

              <div class={styles.managerBody}>
                {m.name && <h4 class={styles.managerName}>{m.name}</h4>}
                {m.role && <p class={styles.managerRole}>{m.role}</p>}

                <div class={styles.managerContacts}>
                  {m.phone && (
                    <a href={m.phoneHref || '#'} aria-label={`${t('contact.phone', 'Telefon')}: ${m.phone}`}>
                      <span class={styles.managerContactIcon} aria-hidden="true"><FiPhone /></span>
                      <span>{m.phone}</span>
                    </a>
                  )}

                  {m.email && (
                    <a href={m.emailHref || '#'} aria-label={`${t('contact.email', 'E-mail')}: ${m.email}`}>
                      <span class={styles.managerContactIcon} aria-hidden="true"><FiMail /></span>
                      <span>{m.email}</span>
                    </a>
                  )}
                </div>
              </div>
            </article>
          );
        })}
      </div>
    </section>
  </div>
</div>

<script is:inline>
  (() => {
    const tabs = Array.from(document.querySelectorAll('[data-history-tab]'));
    const panels = Array.from(document.querySelectorAll('[data-history-panel]'));

    const activateTab = (nextIndex) => {
      tabs.forEach((tab, index) => {
        const selected = index === nextIndex;
        tab.setAttribute('aria-selected', selected ? 'true' : 'false');
        tab.setAttribute('tabindex', selected ? '0' : '-1');
      });

      panels.forEach((panel, index) => {
        const selected = index === nextIndex;
        panel.setAttribute('data-active', selected ? 'true' : 'false');
      });
    };

    tabs.forEach((tab, currentIndex) => {
      tab.addEventListener('click', () => activateTab(currentIndex));
      tab.addEventListener('keydown', (event) => {
        if (!['ArrowLeft', 'ArrowRight', 'Home', 'End'].includes(event.key)) return;
        event.preventDefault();

        let nextIndex = currentIndex;
        if (event.key === 'ArrowRight') nextIndex = (currentIndex + 1) % tabs.length;
        if (event.key === 'ArrowLeft') nextIndex = (currentIndex - 1 + tabs.length) % tabs.length;
        if (event.key === 'Home') nextIndex = 0;
        if (event.key === 'End') nextIndex = tabs.length - 1;

        activateTab(nextIndex);
        tabs[nextIndex]?.focus();
      });
    });

    const revealElements = Array.from(document.querySelectorAll('[data-reveal]'));
    const mediaSpinnerHosts = Array.from(document.querySelectorAll('[data-media-spinner]'));

    mediaSpinnerHosts.forEach((host) => {
      const media = host.querySelector('img,video');
      if (!media) return;

      const markLoaded = () => host.setAttribute('data-loaded', 'true');

      if (media.tagName === 'IMG') {
        if (media.complete) {
          markLoaded();
        } else {
          media.addEventListener('load', markLoaded, { once: true });
          media.addEventListener('error', markLoaded, { once: true });
        }
        return;
      }

      if (media.readyState >= 2) {
        markLoaded();
      } else {
        media.addEventListener('loadeddata', markLoaded, { once: true });
        media.addEventListener('canplay', markLoaded, { once: true });
        media.addEventListener('error', markLoaded, { once: true });
      }
    });

    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.setAttribute('data-visible', 'true');
              observer.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.18 }
      );

      revealElements.forEach((element) => observer.observe(element));
    } else {
      revealElements.forEach((element) => element.setAttribute('data-visible', 'true'));
    }
  })();
</script>
